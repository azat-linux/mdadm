
# create a 4-disk raid10 array, make it 8-disk array.
#
# This SHOULD fail:
# - before mdadm 3.3 and linux 3.5
# - with metadata v0.90
#
# This also fails:
# - with metadata 1.0 with "mdadm: Insufficient head-space for reshape on /dev/loop1" error

m=2
cm=1

for metadata in 1.1 1.2; do
    # 4 disks
    mdadm -CR $md0 --metadata $metadata --level raid10 --raid-disks 4 $dev1 $dev2 $dev3 $dev4
    check wait
    check state UUUU
    check raid10
    testdev $md0 $m $mdsize1 $[512*cm]

    # 8 disks
    mdadm $md0 --add $dev8 $dev9 $dev10 $dev11
    mdadm $md0 --grow --raid-devices 8
    check wait
    check state UUUUUUUU
    check raid10
    testdev $md0 $m $[mdsize1*2] $[512*cm]


    mdadm -S $md0
done
